#!/bin/bash

# Store where spectate is installed to be able to run bin/ scripts

SPECTATE_ROOT=$( \
  cd "$(dirname $(which spectate))" && \
  cd "$(dirname $(readlink spectate))/.." && \
  pwd \
)

# Utility function for logging
CYAN='\033[36m'; BOLD='\033[1m'; NOCOLOR='\033[0m'
log() {
  echo -e "\n${CYAN}[$(date '+%Y-%m-%d %H:%M:%S')] ${BOLD}$1${NOCOLOR}"
  # Append newline unless otherwise noted by the existence of a second arg
  if [ -z "$2" ]; then
    echo ""
  fi
}

# Updating spectate is just git pulling in the spectate repo
spectate_update() {
  log "Updating the spectate repository..."
  (cd "$SPECTATE_ROOT"; git pull)
}

# Spectate update with npm install
spectate_update_install() {
  spectate_update
  log "Installing dependencies..."
  (cd "$SPECTATE_ROOT" ; npm install)
}

# Download Google Doc and write .posthtmlrlc
spectate_download() {
  log "Writing .posthtmlrc..."
  (
    set -x ;
    node --no-warnings process/download-doc.js --spectate-root="$SPECTATE_ROOT" "$@"
  )
}

# Download data
spectate_download_data() {
  log "Downloading data..."
  ( set -x ; node --no-warnings process/download-data.js )
}

# Creates a Spectate project from scratch
spectate_create() {
  spectate_update

  # Identify a template to be used
  TEMPLATE_NAME="$2"
  if [ -z "$TEMPLATE_NAME" ]; then
    TEMPLATE_NAME="default"
  fi

  TEMPLATE_PATH="$SPECTATE_ROOT/templates/$TEMPLATE_NAME"
  if [ ! -d "$TEMPLATE_PATH" ]; then
    echo "Template $TEMPLATE_NAME does not exist."
    return
  fi

  # Copy template into current directory
  log "Copying template $TEMPLATE_NAME..."
  cp -vRn "$TEMPLATE_PATH"/. . || true # Copy without overwrite

  # Install node packages
  if [ -f "package.json" ]; then
    log "Installing node modules..."
    npm install
  fi

  # Create a git repo
  if [ ! -d ".git" ]; then
    log "Initiating git repository..."
    git init
  fi

  spectate_download

  log "Displaying git status..."
  git status
}

# Set remote links for a newly created project
spectate_init() {
  log "Prompting for remote links..."
  node $SPECTATE_ROOT/bin/spectate-init.js "$@"
}

# Clones a spectate project repository and installs node packages
spectate_clone() {
  spectate_update

  log "Cloning repository..."
  if git clone git@github.com:spec-journalism/$2.git ; then
    log "Installing node packages..."
    npm --prefix "$2" install "$2"
  fi
}

# Clears dist folder and builds for production
spectate_build() {
  log "Creating production build..." 0
  rm -f dist/*
  npm run build
}

# Uploads assets to S3 using AWS CLI
upload_assets_awscli() {
  BUILD_SCRIPT=$(cat package.json | \
    python3 -c "import sys, json; print(json.load(sys.stdin)['scripts']['build'])")
  if [[ $BUILD_SCRIPT != *'https://spectator-static-assets.s3.amazonaws.com'* ]]; then
    log "Skipping S3 upload." 0
    return
  fi

  SLUG=$(cat package.json | \
    python3 -c "import sys, json; print(json.load(sys.stdin)['name'])")

  log "Uploading assets, temporarily with the AWS CLI..."
  aws s3 rm "s3://spectator-static-assets/$SLUG/" --recursive --exclude "*" --include "*" --profile=spec
  aws s3 cp dist/ "s3://spectator-static-assets/$SLUG/" --recursive --exclude "*" --include "*" --acl=public-read --profile=spec
}

# Uploads assets to S3 using AWS Node SDK
upload_assets() {
  log "Uploading assets..."
  node $SPECTATE_ROOT/bin/upload-assets.js
}

# Builds and uploads assets
publish() {
  spectate_build
  upload_assets
}

# Uploads assets to S3 using AWS Node SDK
prepublish() {
  log "Setting public S3 URL..."
  node --no-warnings $SPECTATE_ROOT/bin/prepublish.js # suppress fs.promises warning
}

# Publishes on a gh-pages branch which lives in a working tree in dist
gh_publish() {
  # Check out gh-pages into a new working tree in dist if one doesn't already exist
  if [[ $(git worktree list) != *"/dist "* ]]; then
    log "Checking out new gh-pages branch into dist working tree"
    rm -rf dist
    mkdir dist
    git worktree add dist -B gh-pages
    rm -rf dist/* dist/.gitignore dist/.posthtmlrc
  fi

  publish

  log "Pushing changes to origin gh-pages..."
  (cd dist; git add .; git commit -m 'Deploy to gh-pages'; git push origin gh-pages -f)
}

spectate_config_docs() {
  log "Authorizing Google user..."
  node $SPECTATE_ROOT/bin/config-docs.js
}

# Takes intended command
COMMAND=$1

case $COMMAND in
  create) spectate_create "$@" ;;
  init) spectate_init ;;
  clone) spectate_clone "$@" ;;
  download) spectate_download ;;
  download-data) spectate_download_data ;;
  build) spectate_build ;;
  upload-assets) upload_assets ;;
  prepublish) prepublish ;;
  publish) publish ;;
  gh-publish) gh_publish ;;
  config-docs) spectate_config_docs ;;
  update) spectate_update ;;
  update-install) spectate_update_install ;;

  *) 
    if [ -z "$COMMAND" ]; then
      echo "usage: spectate <command>"
      echo
      echo "These are common Spectate commands:"
      echo "  create        Create a Spectate project"
      echo "  init          Set remote links for a newly created project"
      echo "  clone         Clone an existing Spectate project"
      echo "  download      Download the Google Doc"
      echo "  build         Clear the contents of dist/ and npm run build"
      echo "  prepublish    Configure public S3 URL"
      echo "  publish       Build and upload assets"
      echo "  gh-publish    Publish and push to a gh-pages branch"
      echo "  config-docs   Reset Google Docs authentication"
      echo "  update        Update Spectate itself"
    else
      echo "Unknown command: $COMMAND"
    fi
esac
